<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biogen Patient Services</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .typing-indicator {
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md text-white">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Biogen Patient Services</h1>
                <p class="text-blue-100">AI-Powered Healthcare Support</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="login('patient')" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                    <i data-lucide="user" class="w-5 h-5"></i>
                    <span>Login as Patient (Sarah Parker)</span>
                </button>
                
                <button onclick="login('agent')" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                    <i data-lucide="headphones" class="w-5 h-5"></i>
                    <span>Login as Agent (Cindy Smith)</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <i data-lucide="heart" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-semibold text-gray-900">Biogen Patient Services</h1>
                            <p class="text-sm text-gray-500" id="userInfo">Welcome back!</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Patient Dashboard -->
        <div id="patientDashboard" class="hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Welcome Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border border-blue-200">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-lg">SP</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Welcome back, Sarah!</h2>
                            <p class="text-gray-600">Relapsing-Remitting MS • Tysabri Therapy</p>
                        </div>
                    </div>
                    <p class="text-gray-700">Your next infusion is scheduled for <strong>October 25, 2025</strong>. We're here to support you every step of the way.</p>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="openChatModal()" class="bg-white rounded-xl p-4 shadow-sm border hover:shadow-md transition-shadow text-left">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="brain" class="w-4 h-4 text-purple-600"></i>
                            </div>
                            <span class="font-medium text-gray-900">AI Support</span>
                        </div>
                        <p class="text-sm text-gray-600">Ask questions 24/7</p>
                    </button>
                    
                    <button onclick="contactAgent()" class="bg-white rounded-xl p-4 shadow-sm border hover:shadow-md transition-shadow text-left">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="message-circle" class="w-4 h-4 text-green-600"></i>
                            </div>
                            <span class="font-medium text-gray-900">Contact Your Rep</span>
                        </div>
                        <p class="text-sm text-gray-600">Get help from Cindy</p>
                    </button>
                </div>

                <!-- Journey Tracker -->
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-2 text-indigo-600"></i>
                        Your Treatment Journey
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">MS Diagnosis</p>
                                <p class="text-sm text-gray-600">October 20, 2025</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="check" class="w-4 h-4 text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Treatment Plan</p>
                                <p class="text-sm text-gray-600">Tysabri approved</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="calendar" class="w-4 h-4 text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">First Infusion</p>
                                <p class="text-sm text-gray-600">October 25, 2025</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Dashboard -->
        <div id="agentDashboard" class="hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Welcome Section -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 mb-6 border border-green-200">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-lg">CS</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Welcome back, Cindy!</h2>
                            <p class="text-gray-600">Patient Services Agent • Biogen</p>
                        </div>
                    </div>
                    <p class="text-gray-700">You have <strong>3 active patients</strong> today. AI is handling routine questions while you focus on complex cases.</p>
                </div>

                <!-- AI Configuration -->
                <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 mb-6 border border-emerald-200">
                    <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i data-lucide="database" class="w-5 h-5 mr-2 text-emerald-600"></i>
                        AI Configuration
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">LLM Provider</h4>
                            <select id="llmProvider" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="openai">OpenAI GPT-4</option>
                                <option value="gemini">Google Gemini Pro</option>
                                <option value="claude">Anthropic Claude</option>
                                <option value="demo">Demo Mode</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="testAI()" class="w-full bg-emerald-600 text-white px-3 py-2 rounded text-sm hover:bg-emerald-700 transition-colors">
                                Test AI Connection
                            </button>
                        </div>
                    </div>
                    <div id="aiStatus" class="text-sm text-gray-600">
                        Click "Test AI Connection" to check status
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="openChatModal()" class="bg-white rounded-xl p-4 shadow-sm border hover:shadow-md transition-shadow text-left">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="brain" class="w-4 h-4 text-purple-600"></i>
                            </div>
                            <span class="font-medium text-gray-900">Test AI</span>
                        </div>
                        <p class="text-sm text-gray-600">Try AI responses</p>
                    </button>
                    
                    <button onclick="viewPatientData()" class="bg-white rounded-xl p-4 shadow-sm border hover:shadow-md transition-shadow text-left">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="users" class="w-4 h-4 text-blue-600"></i>
                            </div>
                            <span class="font-medium text-gray-900">View Patient Data</span>
                        </div>
                        <p class="text-sm text-gray-600">Patient insights</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-2xl h-[600px] flex flex-col">
            <!-- Chat Header -->
            <div class="flex items-center justify-between p-4 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                        <i data-lucide="brain" class="w-4 h-4 text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">AI Assistant</h3>
                        <p class="text-sm text-gray-600">Ask me anything about MS or Tysabri</p>
                    </div>
                </div>
                <button onclick="closeChatModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                        <i data-lucide="brain" class="w-3 h-3 text-purple-600"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                        <p class="text-sm text-gray-700">Hi! I'm your AI assistant. I can help you with questions about MS, Tysabri treatment, side effects, appointments, and more. What would you like to know?</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="chatInput" placeholder="Ask me anything..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <button onclick="sendChatMessage()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRole = '';
        let currentUser = '';
        let authToken = '';

        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // Login function
        async function login(role) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    currentRole = role;
                    currentUser = data.user.name;
                    
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    if (role === 'patient') {
                        document.getElementById('patientDashboard').classList.remove('hidden');
                        document.getElementById('userInfo').textContent = 'Patient • Sarah Parker';
                    } else {
                        document.getElementById('agentDashboard').classList.remove('hidden');
                        document.getElementById('userInfo').textContent = 'Agent • Cindy Smith';
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        // Logout function
        function logout() {
            currentRole = '';
            currentUser = '';
            authToken = '';
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('agentDashboard').classList.add('hidden');
            closeChatModal();
        }

        // Chat modal functions
        function openChatModal() {
            document.getElementById('chatModal').classList.remove('hidden');
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.add('hidden');
        }

        // Send chat message
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage('user', message);
                input.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                try {
                    const provider = document.getElementById('llmProvider')?.value || 'demo';
                    const response = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ 
                            message, 
                            provider,
                            context: {
                                diagnosis: "Relapsing-Remitting MS",
                                therapy: "Tysabri",
                                diagnosisDate: "October 20, 2025",
                                nextInfusion: "October 25, 2025",
                                location: "Palo Alto, CA"
                            }
                        })
                    });

                    const data = await response.json();
                    hideTypingIndicator();
                    
                    if (data.response) {
                        addMessage('ai', data.response);
                    } else {
                        addMessage('ai', 'I apologize, but I encountered an error. Please try again.');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    hideTypingIndicator();
                    addMessage('ai', 'I apologize, but I encountered an error. Please try again.');
                }
            }
        }

        // Add message to chat
        function addMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-3 ${sender === 'user' ? 'justify-end' : ''}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white rounded-lg p-3 max-w-xs">
                        <p class="text-sm">${message}</p>
                    </div>
                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-blue-600 font-medium text-xs">U</span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                        <i data-lucide="brain" class="w-3 h-3 text-purple-600"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                        <div class="text-sm text-gray-700">${formatMessage(message)}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Re-initialize Lucide icons for new elements
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-start space-x-3';
            typingDiv.innerHTML = `
                <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                    <i data-lucide="brain" class="w-3 h-3 text-purple-600"></i>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Format message with basic markdown
        function formatMessage(message) {
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        // Test AI connection
        async function testAI() {
            const statusDiv = document.getElementById('aiStatus');
            const provider = document.getElementById('llmProvider').value;
            
            statusDiv.innerHTML = 'Testing AI connection...';
            
            try {
                const response = await fetch(`/api/ai/test?provider=${provider}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = `✅ ${data.provider} AI is working! Response: "${data.response}"`;
                    statusDiv.className = 'text-sm text-green-600';
                } else {
                    statusDiv.innerHTML = `❌ ${data.provider} AI test failed: ${data.error}`;
                    statusDiv.className = 'text-sm text-red-600';
                }
            } catch (error) {
                statusDiv.innerHTML = `❌ Connection test failed: ${error.message}`;
                statusDiv.className = 'text-sm text-red-600';
            }
        }

        // Contact agent
        function contactAgent() {
            alert('WhatsApp integration would connect you with your Patient Services Agent Cindy Smith.');
        }

        // View patient data
        async function viewPatientData() {
            try {
                const response = await fetch('/api/patients/data/patient_001', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                const patient = data.patient;
                
                const patientInfo = `📊 Patient Data:

👤 ${patient.name} (${patient.id}):
• Diagnosis: ${patient.diagnosis}
• Therapy: ${patient.therapy}
• Next Infusion: ${patient.nextInfusion}
• Adherence: ${patient.adherence}%
• Satisfaction: ${patient.satisfaction}%
• Total Interactions: ${patient.totalInteractions}
• Sentiment Trend: ${patient.sentimentTrend}

🎯 Risk Factors: ${patient.riskFactors.join(', ')}`;
                
                alert(patientInfo);
            } catch (error) {
                console.error('Patient data error:', error);
                alert('Failed to load patient data.');
            }
        }

        // Allow Enter key to send messages
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>
